<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>文件读取【file】并上传文件，火狐3.6+ chrome6+</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="" rel="stylesheet">
<script type="text/javascript" src="http://cdn.brotsoft.com/static/package/zepto.js"></script>
</head>
<body>
<h3>文件读取【file】并上传文件，火狐3.6+ chrome6+ </h3>
<div class="file"><input id="file" type="file" name="file"></div>
<div id="show" style="display:none">
    <p>文件名称:<span id="name"></span></p>
    <p>文件大小:<span id="size"></span></p>
    <p>文件进度:<span id="progress"></span> %</p>
    <p>文件速度:<span id="fast"></span>KB</p>
    <p>文件上传用时:<span id="time"></span>秒</p>
    <p id="imagesShow" data-maxWidth="600"></p>
</div>

<script type="text/javascript">



/**
 * 参考文献 ：http://www.iunbug.com/archives/2012/06/04/220.html
 */
$('#file').change(function(event) {
    var file = $(this).get(0).files[0];
    //设置文字大小
    if(file.size < 1024){
        str = file.size + ' Byte';
    }else if(file.size <= 1024*1024 && file.size >= 1024){
        var num = (file.size/1024).toFixed(2);
        var str = num + ' KB';
    }else{
        var num = (file.size/1024/1024).toFixed(2);
        var str = num + ' M';
    }

    $('#size').html(str);
    /**
     * [reader description] 读取文件信息
     * @type {FileReader}
     */
    var reader = new FileReader();
    reader.onload = function( evt ){
        //假如是图片文件设置预览功能
        if(file.type.indexOf('image') != -1 || 0){
           var mx = $('#imagesShow').attr('data-maxWidth');
           var img = new Image();
           img.onload = function(){
             var width = this.width;
             if(width >= mx ){
              this.width = mx;
             }
             $('#imagesShow').html(this);
             $('#show').show();
           }
           img.src = evt.target.result;
           return;
        }else{
           $('#imagesShow').hide();
        }
    }
    reader.readAsDataURL(file); //【readAsDataURL，readAsText，readAsBinaryString,readAsArrayBuffer】
    $('#show').show();


    CXGHTML5Upload({
        file : file,
        onProgress : function(obj){
            $('#progress').html((obj.loaded/obj.length*100).toFixed(2));
            $('#fast').html((obj.fast/1024).toFixed(2));
            $('#time').html(obj.time);
        },
        onComplete : function(ret){
            console.log('Complete',ret);
        },
        onError : function(ret){
            console.log('erroe',ret)
        },
        url : 'http://www.e56buy.com/upload.php',
        upLoadKey : 'upload_box'
    });

    $(this).val('');
});

/**
 * [description] 上传
 * @return {[type]} [description]
 */
;(function(){
    var lastObj = null;
    var define = {
        upLoadKey : 'file',
        file : null,
        onProgress : null,
        onComplete : null,
        onError : null,
        data : {},
        url : null
    }

    /**
     * [extend description] 合并项 _extend({a:1,b:2,c:2,d:3},{d:5,f:6,e:70})
     * @param  {[type]} defined [description] 默认选项卡
     * @param  {[type]} options [description] 需要合并选项卡
     * @return {[type]}         [description]
     */
    var _extend = function(defined,options){
        var obj = {};
        for(var key in defined){
            obj[key] = defined[key];
        }

        for(var k in options){
            obj[k] = options[k];
        }
        return obj;
    };

    /**
     * [uploadFile description] 上传处理
     * @return {[type]} [description]
     */
    var uploadFile = function(options){
        this.options = _extend(define,options ? options : {});
        this.time = 0;
        this.fast = 0;
        this.loadedSave = 0;
        this.timeer = null;
        this.PrevLoadedSave = 0;
        this.len = 0;
        this.useTime = 0;
    }

    //扩展
    uploadFile.prototype = {

        /**
         * [int description] 初始化
         * @return {[type]} [description]
         */
        int : function(){
            var that = this;
            //FormData对象、文件对象、上传地址不存在不处理
            if(!window.FormData || !this.options.file || !this.options.url) return false;

            var xhr = new XMLHttpRequest();     //创建异步对象
            var form = new FormData();          //创建表单对象
            form.append(this.options.upLoadKey,this.options.file);

            //绑定上传进度事件
            if(xhr.upload && typeof this.options.onProgress == 'function'){
                 this.progress(xhr);
            }

            // 文件上传成功或是失败
            xhr.onreadystatechange = function(e) {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        if(typeof that.options.onComplete == 'function') that.options.onComplete(xhr.responseText);
                    } else {
                        if(typeof that.options.onError == 'function') that.options.onError(xhr);
                    }
                }
            };

            // 开始上传
            xhr.open("POST", this.options.url, true);
            xhr.send(form);
            this.time = new Date().getTime();
            this.fastInterCode();
        },

        /**
         * [fastcode description] 计算网速
         * @return {[type]} [description]
         */
        fastcodeConut : 0,
        fastcodeTime : 1,
        fastcode : function(){
            this.fast = this.loadedSave - this.PrevLoadedSave;

            //当前后一秒钟数据相当时候，网速为0
            if(this.fastcodeConut>0 && this.loadedSave == this.PrevLoadedSave) this.fast = 0;
            this.fastcodeConut++;
            this.PrevLoadedSave = this.loadedSave;
            this.useTime = this.fastcodeTime;
            this.fastcodeTime++;
        },

        /**
         * [fast description] 计算网速定时器
         * @return {[type]} [description]
         */
        fastInterCode : function(){
            var that = this;
            this.useTime = 1;
            this.timeer = setInterval(function(){
                that.fastcode();
            },1000);
            //that.fastcode();
        },

        /**
         * [onProgress description] 上传进度处理
         * @param  {[type]} xhr [description]
         * @return {[type]}     [description]
         */
        progress : function(xhr){
            var that = this;
            if(typeof this.options.onProgress == 'function' ){
                xhr.upload.addEventListener("progress", function(e) {
                    var obj = { loaded : e.loaded, length : e.total,fast : that.fast,time : that.useTime}
                    //上传第一秒处理
                    if(new Date().getTime() - that.time <= 1000){
                        obj['fast'] = e.loaded;
                        that.useTime = ((new Date().getTime() - that.time)/1000).toFixed(2);
                        obj['time'] = that.useTime;
                    }
                    that.options.onProgress(obj);
                    that.loadedSave = e.loaded;
                    if(e.loaded >= e.total) clearInterval(that.timeer);
                }, false);
            }
        }
    }

    /**
     * [createObj description] 对象实例化
     * @param  {[type]} options [description] 选项卡
     * @return {[type]}         [description]
     */
    var createObj = function(options){
        if(lastObj) lastObj = null;
        lastObj = new uploadFile(options);
        return lastObj
    };

    /**
     * [CXGResetScroll description] 对外接口
     * @param {[type]} options [description] 选项卡
     */
    CXGHTML5Upload = function(options){
        options = options ? options : {};
        createObj(options).int();
    }
})();




</script>
</body>
</html>
